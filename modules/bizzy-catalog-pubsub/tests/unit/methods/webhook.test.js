'use strict';

const Promise = require('bluebird');
const test = require('ava');
const sinon = require('sinon');
const {
    BizzyError
} = require('bizzy-common');
const method = require('../../../src/methods/webhook');
const generalConfig = require('../../../src/repositories/general_configuration_repo');
const skuMappingJob = require('../../../src/repositories/product_sku_mapping_job_repo');
const skuMapping = require('../../../src/repositories/product_sku_mapping_repo');
const catalogPubsubService = require('../../../src/repositories/catalog_pubsub_service_repo');

const content = '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'

test.serial('upsertProductSkuMapping SUCCESS done, no job to be processed', async (t) => {
    t.context.sandbox.stub(generalConfig, 'findOne').resolves();
    t.context.sandbox.stub(skuMappingJob, 'findOneGeneralCriteria').resolves(null);

    try {
        const result = await method.upsertProductSkuMapping({ id: '123ppp' }, {});
        t.is(result, 'success-done');
    } catch (err) {
        t.fail(err.stack);
    }
});

test.serial('upsertProductSkuMapping SUCCESS type add', async (t) => {
    t.context.sandbox.stub(generalConfig, 'findOne').resolves({ product_sku_mapping_job_concurrency: 10 });
    t.context.sandbox.stub(skuMappingJob, 'findOneGeneralCriteria').resolves({ content, status: 10, type: 'add' });
    t.context.sandbox.stub(skuMapping, 'syncProductSkuMapping').resolves();
    t.context.sandbox.stub(skuMappingJob, 'updateOne').resolves();
    t.context.sandbox.stub(catalogPubsubService, 'upsertProductSkuMapping').resolves();

    try {
        const result = await method.upsertProductSkuMapping({ id: '123ppp' }, {});
        t.is(result, 'success');
    } catch (err) {
        t.fail(err.stack);
    }
});

test.serial('upsertProductSkuMapping ERROR', async (t) => {
    t.context.sandbox.stub(generalConfig, 'findOne').resolves({ product_sku_mapping_job_concurrency: 10 });
    t.context.sandbox.stub(skuMappingJob, 'findOneGeneralCriteria').resolves({ content, status: 10, type: 'add' });
    t.context.sandbox.stub(skuMapping, 'syncProductSkuMapping').resolves();
    t.context.sandbox.stub(skuMappingJob, 'updateOne').resolves();
    t.context.sandbox.stub(catalogPubsubService, 'upsertProductSkuMapping').throws(new Error('error'));

    try {
        await method.upsertProductSkuMapping({ id: '123ppp' }, {});
        t.fail('should error');
    } catch (err) {
        t.is(err.message, 'error');
    }
});

test.serial('upsertProductSkuMapping SUCCESS type remove', async (t) => {
    t.context.sandbox.stub(generalConfig, 'findOne').resolves({ product_sku_mapping_job_concurrency: 10 });
    t.context.sandbox.stub(skuMappingJob, 'findOneGeneralCriteria').resolves({ content, status: 10, type: 'remove' });
    t.context.sandbox.stub(skuMapping, 'deleteManyProductMapping').resolves();
    t.context.sandbox.stub(skuMappingJob, 'updateOne').resolves();
    t.context.sandbox.stub(catalogPubsubService, 'upsertProductSkuMapping').resolves();

    try {
        const result = await method.upsertProductSkuMapping({ id: '123ppp' }, {});
        t.is(result, 'success');
    } catch (err) {
        t.fail(err.stack);
    }
});

test.before('Initialize Bizzy Error', function* before(t) {
    BizzyError.initializeErrors();
});

test.beforeEach('Initialize New Sandbox Before Each Test', function* beforeEach(t) {
    t.context.sandbox = sinon.sandbox.create().usingPromise(Promise.Promise);
});

test.afterEach.always('Restore Sandbox and Configuration After Each Test', function* afterEach(t) {
    t.context.sandbox.restore();
});
